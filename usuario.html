<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>AJE Coins - Usuario</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>
<div class="container">
<h1>Consulta tus AJE Coins</h1>

<input type="text" id="cedulaInput" placeholder="Ingresa tu cÃ©dula">
<button id="buscarBtn">Buscar</button>

<p id="mensaje"></p>
<div id="alertaCoins" style="display:none"></div>

<div id="infoUsuario" style="display:none;">
    <h3>Datos del usuario</h3>
    <p><strong>Nombre:</strong> <span id="nombre"></span></p>
    <p><strong>CEDIS:</strong> <span id="cedis"></span></p>
    <p><strong>Coins actuales:</strong> <span id="coinsActuales"></span></p>

    <h3>Historial</h3>
    <table id="tablaHistorial">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Coins ganados</th>
                <th>Producto</th>
                <th>Coins canjeados</th>
                <th>Saldo</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3>Productos</h3>
    <div id="productosContainer"></div>

    <div id="carrito">
        <h4>Carrito</h4>
        <ul id="listaCarrito"></ul>
        <button id="btnSolicitar">Solicitar productos</button>
    </div>
</div>

<br>
<a href="index.html">â¬… Volver</a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, getDocs, setDoc, collection
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCsz2EP8IsTlG02uU2_GRfyQeeajMDuJjI",
  authDomain: "ajecoins-73829.firebaseapp.com",
  projectId: "ajecoins-73829",
  storageBucket: "ajecoins-73829.firebasestorage.app",
  messagingSenderId: "247461322350",
  appId: "1:247461322350:web:802185ad39249ca650507f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const coinsActualesSpan = document.getElementById("coinsActuales");
const tablaBody = document.querySelector("#tablaHistorial tbody");
const productosContainer = document.getElementById("productosContainer");
const listaCarrito = document.getElementById("listaCarrito");
const alertaCoins = document.getElementById("alertaCoins");

let coinsUsuario = 0;
let carrito = [];

/* =======================
   MOSTRAR USUARIO
======================= */
async function mostrarUsuario(cedula) {
  tablaBody.innerHTML = "";
  productosContainer.innerHTML = "";
  carrito = [];

  const userSnap = await getDoc(doc(db, "usuarios", cedula));
  if (!userSnap.exists()) return;

  document.getElementById("nombre").innerText = userSnap.data().nombre;
  document.getElementById("cedis").innerText = userSnap.data().cedis;

  // ðŸ”¥ CALCULAR SALDO DESDE MOVIMIENTOS
  let saldo = 0;
  const movs = await getDocs(collection(db, "usuarios", cedula, "movimientos"));

  movs.forEach(m => {
    const d = m.data();
    saldo += (d.coins_ganados || 0);
    saldo -= (d.coins_canjeados || 0);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.fecha}</td>
      <td>${d.coins_ganados || 0}</td>
      <td>${d.producto || "-"}</td>
      <td>${d.coins_canjeados || 0}</td>
      <td>${saldo}</td>
    `;
    tablaBody.appendChild(tr);
  });

  coinsUsuario = saldo;
  coinsActualesSpan.innerText = saldo;
  document.getElementById("infoUsuario").style.display = "block";

  // PRODUCTOS
  const prods = await getDocs(collection(db, "productos"));
  prods.forEach(p => {
    const prod = p.data();
    const div = document.createElement("div");
    div.innerHTML = `
      <img src="${prod.imagen}">
      <p>${prod.nombre}</p>
      <p>${prod.coins} coins</p>
      <button onclick="agregar('${prod.nombre}', ${prod.coins})">+ Agregar</button>
    `;
    productosContainer.appendChild(div);
  });
}

window.agregar = (nombre, coins) => {
  const total = carrito.reduce((s,i)=>s+i.coins*i.cantidad,0);
  if (total + coins > coinsUsuario) {
    alertaCoins.innerText = "âŒ Usuario excediÃ³ el monto de coins actuales";
    alertaCoins.style.display = "block";
    return;
  }
  const ex = carrito.find(p=>p.nombre===nombre);
  ex ? ex.cantidad++ : carrito.push({nombre, coins, cantidad:1});
  renderCarrito();
};

function renderCarrito(){
  listaCarrito.innerHTML="";
  let total=0;
  carrito.forEach(p=>{
    total+=p.coins*p.cantidad;
    listaCarrito.innerHTML+=`<li>${p.nombre} x${p.cantidad}</li>`;
  });
  coinsActualesSpan.innerText = coinsUsuario - total;
}

/* =======================
   SOLICITAR PRODUCTOS
======================= */
document.getElementById("btnSolicitar").onclick = async ()=>{
  if(carrito.length===0) return;
  const cedula = document.getElementById("cedulaInput").value;
  const fecha = new Date().toLocaleDateString("es-EC");
  let total=0;

  for(const p of carrito){
    total+=p.coins*p.cantidad;
    await setDoc(doc(collection(db,"usuarios",cedula,"movimientos")),{
      fecha,
      producto:p.nombre,
      coins_canjeados:p.coins*p.cantidad,
      coins_ganados:0
    });
  }

  await setDoc(doc(db,"usuarios",cedula),
    { coins_actuales: coinsUsuario-total },
    { merge:true }
  );

  alertaCoins.innerText="âœ… Productos solicitados correctamente";
  alertaCoins.style.display="block";
};

document.getElementById("buscarBtn").onclick=()=>{
  mostrarUsuario(document.getElementById("cedulaInput").value);
};
</script>
</body>
</html>
