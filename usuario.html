<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AJE Coins</title>

<style>
/* ===== MOBILE FIRST ===== */
body {
    margin: 0;
    background: #f2f2f2;
    font-family: system-ui, -apple-system;
}

.app {
    max-width: 430px;
    margin: auto;
    background: #fff;
    min-height: 100vh;
}

/* HEADER */
.header {
    background: #00a651;
    color: #fff;
    padding: 15px;
    text-align: center;
    font-weight: bold;
}

/* CONTENT */
.content {
    padding: 15px;
}

/* INPUT */
input {
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid #ddd;
    margin-bottom: 10px;
}

button {
    width: 100%;
    padding: 12px;
    border-radius: 14px;
    border: none;
    background: #00a651;
    color: #fff;
    font-weight: bold;
    font-size: 15px;
}

/* CARDS */
.card {
    background: #fff;
    border-radius: 18px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,.08);
}

/* PRODUCTS */
.products {
    display: grid;
    grid-template-columns: repeat(2,1fr);
    gap: 12px;
}

.product {
    background: #fafafa;
    border-radius: 16px;
    padding: 10px;
    text-align: center;
}

.product img {
    height: 80px;
    object-fit: contain;
}

/* CART */
.cart {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding: 10px;
    border-top: 1px solid #eee;
}

/* ALERT */
.alert {
    background: #ff4d4d;
    color: #fff;
    padding: 10px;
    border-radius: 12px;
    text-align: center;
    display: none;
}

/* LINK */
.link {
    text-align: center;
    color: #00a651;
    font-weight: bold;
    margin-top: 10px;
}
</style>
</head>

<body>
<div class="app">

<div class="header">AJE Coins</div>

<div class="content">
    <input id="cedula" placeholder="Ingresa tu cÃ©dula">
    <button id="buscar">Buscar</button>

    <div id="alert" class="alert"></div>

    <div id="vistaUsuario" style="display:none">

        <div class="card">
            <b id="nombre"></b><br>
            Coins disponibles: <b id="coins"></b>
        </div>

        <div class="card">
            <h4>Productos</h4>
            <div id="productos" class="products"></div>
        </div>

        <div class="card">
            <button id="verSolicitudes">ðŸ§¾ Mis productos solicitados</button>
        </div>

    </div>
</div>

<div class="cart" id="carrito" style="display:none">
    <div id="lista"></div>
    <button id="solicitar">Solicitar productos</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyCsz2EP8IsTlG02uU2_GRfyQeeajMDuJjI",
  projectId: "ajecoins-73829"
});

const db = getFirestore(app);

let coinsUsuario = 0;
let carrito = [];
let cedulaGlobal = "";

const alert = msg => {
    const a = document.getElementById("alert");
    a.innerText = msg;
    a.style.display = "block";
    setTimeout(()=>a.style.display="none",3000);
};

document.getElementById("buscar").onclick = async ()=>{
    cedulaGlobal = document.getElementById("cedula").value;
    const snap = await getDoc(doc(db,"usuarios",cedulaGlobal));
    if (!snap.exists()) return alert("Usuario no encontrado");

    const u = snap.data();
    coinsUsuario = u.coins_actuales;

    document.getElementById("nombre").innerText = u.nombre;
    document.getElementById("coins").innerText = coinsUsuario;

    document.getElementById("vistaUsuario").style.display="block";
    document.getElementById("carrito").style.display="block";

    const cont = document.getElementById("productos");
    cont.innerHTML = "";

    const ps = await getDocs(collection(db,"productos"));
    ps.forEach(p=>{
        const d = p.data();
        const div = document.createElement("div");
        div.className="product";
        div.innerHTML = `
            <img src="${d.imagen||''}">
            <b>${d.nombre}</b>
            <p>${d.coins} coins</p>
            <button>Agregar</button>
        `;
        div.querySelector("button").onclick=()=>{
            if (d.coins > coinsUsuario) return alert("Coins insuficientes");
            carrito.push({nombre:d.nombre,coins:d.coins,cantidad:1});
            renderCarrito();
        };
        cont.appendChild(div);
    });
};

function renderCarrito(){
    const l = document.getElementById("lista");
    l.innerHTML="";
    let total=0;
    carrito.forEach(p=>{
        total+=p.coins;
        l.innerHTML+=`â€¢ ${p.nombre} (${p.coins})<br>`;
    });
    document.getElementById("coins").innerText = coinsUsuario - total;
}

document.getElementById("solicitar").onclick = async ()=>{
    if (!carrito.length) return alert("Carrito vacÃ­o");

    const total = carrito.reduce((s,p)=>s+p.coins,0);

    await addDoc(collection(db,"usuarios",cedulaGlobal,"solicitudes"),{
        fecha: new Date().toISOString(),
        estado: "pendiente",
        productos: carrito,
        total_coins: total
    });

    await setDoc(doc(db,"usuarios",cedulaGlobal),{
        coins_actuales: coinsUsuario - total
    },{merge:true});

    alert("âœ… Productos solicitados");
    carrito=[];
};
</script>
</body>
</html>
